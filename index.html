<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Casa Carmaretti | POS</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Inconsolata:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Framework -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="app-theme">

  <!-- App Container -->
  <div class="app-shell">

    <!-- 1. Header (Desktop & Mobile) -->
    <header class="topbar">
      <div class="topbar-brand">
        <div class="brand-mark"><img src="artifacts/italy.png" style="width: 40px; height: 40px; object-fit: contain;">
        </div>
        <div>
          <h1 class="brand-title">CASA CARMARETTI</h1>
          <div class="brand-meta">
            <span id="kds-clock" class="clock-tag d-none d-lg-inline-flex">--:--</span>
          </div>
        </div>
      </div>

      <div class="topbar-actions d-none d-lg-flex">
        <!-- Açık Masalar -->
        <button class="action-pill" data-bs-toggle="modal" data-bs-target="#activeOrdersModal">
          <i class="bi bi-clock-history"></i>Açık
          <span id="activeOrderBadge" class="badge bg-danger rounded-pill ms-1 d-none">0</span>
        </button>

        <!-- Geçmiş -->
        <button class="action-pill" data-bs-toggle="modal" data-bs-target="#historyModal">
          <i class="bi bi-journal-check"></i>Geçmiş
        </button>

        <!-- Leaderboard -->
        <button class="action-pill" data-bs-toggle="modal" data-bs-target="#leaderboardModal">
          <i class="bi bi-trophy"></i>Skor
        </button>

        <div class="action-divider"></div>

        <!-- KDS/Cashier (role-based) -->
        <button id="btn-toggle-kds" class="action-pill d-none">
          <i class="bi bi-display"></i>Mutfak
        </button>
        <button id="btn-toggle-cashier" class="action-pill alt d-none">
          <i class="bi bi-cash-stack"></i>Kasa
        </button>

        <div class="action-divider"></div>

        <!-- Sound Toggle -->
        <button id="btn-sound-toggle" class="action-pill icon-only" title="Ses Aç/Kapa">
          <i class="bi bi-volume-up-fill"></i>
        </button>

        <!-- Theme Toggle -->
        <button id="btn-theme-toggle" class="action-pill icon-only" title="Tema Değiştir">
          <i class="bi bi-moon-fill"></i>
        </button>
      </div>

      <!-- User Profile (Desktop Only - Mobile uses 'More' tab) -->
      <div class="topbar-profile d-none d-lg-flex">
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-label">SİPARİŞ</span>
            <strong id="waiterOrderCount">0</strong>
          </div>
          <div class="stat">
            <span class="stat-label">SERVİS</span>
            <strong id="waiterServiceShare" class="stat-positive">0 $</strong>
          </div>
        </div>

        <div class="profile-info">
          <div class="profile-text">
            <p class="profile-name" id="activeWaiterName">Giriş Yap</p>
            <p class="profile-rank" id="waiterRank">-</p>
          </div>
          <div class="profile-avatar"><i class="bi bi-person-fill"></i></div>
        </div>
      </div>
    </header>

    <!-- 2. Main Content Area -->
    <main class="app-main">

      <!-- VIEW: POS (Menu & Ticket) -->
      <div id="pos-view" class="pos-view">

        <!-- Left: Product Grid (Full width on mobile) -->
        <div class="pos-grid">
          <!-- Categories / Filter Bar -->
          <div class="filter-rail">
            <div class="search-wrapper">
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-darker border-secondary text-secondary"><i
                    class="bi bi-search"></i></span>
                <input type="text" id="productSearch" class="form-control bg-darker border-secondary text-white"
                  placeholder="Ürün Ara...">
              </div>
            </div>
          </div>

          <!-- Products Scroll Area -->
          <div id="categories" class="pos-categories">
            <!-- JS Injects Products Here -->
          </div>
        </div>

        <!-- Right: Ticket Sidebar (Desktop Only) -->
        <aside class="ticket-sidebar d-none d-lg-flex">
          <!-- Content injected via common function or duplicated? 
               We will use the same container ID 'ticketItemsContainer' but we need to handle mobile offcanvas.
               Actually, let's use ONE container and move it based on screen size? 
               No, easier to have the Offcanvas be the MAIN ticket container for simpler DOM.
               BUT Bootstrap Offcanvas is a modal-like overlay.
               
               Strategy: The "Ticket" checks screen size. 
               For now, let's keep Desktop Sidebar separate structure for layout stability.
          -->
          <div class="ticket-header">
            <div class="ticket-title">
              <span class="ticket-label">Adisyon</span>
            </div>
            <input type="text" id="calcName" class="form-control ticket-input" placeholder="MASA NO / MÜŞTERİ">
          </div>

          <div id="desktop-ticket-items" class="ticket-items">
            <ul id="liveCartList" class="list-unstyled mb-0"></ul>
          </div>

          <div class="ticket-footer">
            <div class="ticket-row">
              <span>Ara Toplam</span><span id="subTotal">0 $</span>
            </div>
            <div class="ticket-row ticket-row-accent">
              <span>Servis</span><span>+200 $</span>
            </div>
            <div class="ticket-total">
              <span>TOPLAM</span><span id="totalPrice">0 $</span>
            </div>
            <button id="saveButton" class="btn btn-gold w-100 fw-bold py-3">MUTFAĞA İLET <i
                class="bi bi-send-fill ms-2"></i></button>
          </div>
        </aside>
      </div>

      <!-- VIEW: KDS -->
      <div id="kds-view" class="kds-view d-none">
        <div class="view-shell">
          <div class="view-header">
            <div>
              <span class="view-kicker">Mutfak</span>
              <h2 class="view-title"><i class="bi bi-fire text-danger me-2"></i>MUTFAK EKRANI</h2>
            </div>
            <button class="btn btn-outline-light btn-sm" onclick="switchView('pos')">
              <i class="bi bi-arrow-left"></i> POS'a Dön
            </button>
          </div>
          <div id="kds-grid" class="row g-3"></div>
        </div>
      </div>

      <!-- VIEW: CASHIER -->
      <div id="cashier-view" class="cashier-view d-none">
        <div class="view-shell">
          <div class="view-header">
            <div>
              <span class="view-kicker">Kasa</span>
              <h2 class="view-title"><i class="bi bi-cash-stack text-success me-2"></i>KASA EKRANI</h2>
            </div>
            <button class="btn btn-outline-light btn-sm" onclick="switchView('pos')">
              <i class="bi bi-arrow-left"></i> POS'a Dön
            </button>
          </div>
          <div id="cashier-grid" class="row g-3"></div>
        </div>
      </div>

    </main>

    <!-- 3. Bottom Navigation (Mobile Only) -->
    <nav class="mobile-nav d-lg-none">
      <button class="nav-item btn btn-link d-flex flex-column align-items-center active" onclick="switchView('pos')">
        <i class="bi bi-grid-fill fs-5"></i>
        <span class="x-small">Menü</span>
      </button>

      <button class="nav-item btn btn-link d-flex flex-column align-items-center position-relative"
        data-bs-toggle="offcanvas" data-bs-target="#ticketOffcanvas">
        <i class="bi bi-receipt fs-5"></i>
        <span class="x-small">Adisyon</span>
        <span id="mobileCartBadge"
          class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-gold text-dark d-none">0</span>
      </button>

      <button class="nav-item btn btn-link d-flex flex-column align-items-center" data-bs-toggle="modal"
        data-bs-target="#activeOrdersModal">
        <i class="bi bi-clock-history fs-5"></i>
        <span class="x-small">Açık</span>
      </button>

      <button class="nav-item btn btn-link d-flex flex-column align-items-center" data-bs-toggle="offcanvas"
        data-bs-target="#moreMenuOffcanvas">
        <i class="bi bi-three-dots fs-5"></i>
        <span class="x-small">Diğer</span>
      </button>
    </nav>

  </div>

  <!-- OFFCANVAS: Mobile Ticket -->
  <div class="offcanvas offcanvas-bottom h-75 surface-elevated text-main" tabindex="-1" id="ticketOffcanvas">
    <div class="offcanvas-header border-theme">
      <h5 class="offcanvas-title fw-bold">Adisyon</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column" id="mobileTicketBody">
      <!-- Content mirrored from desktop via JS -->
      <div class="p-3">
        <input type="text" id="mobileCalcName" class="form-control surface-ground text-main border-theme text-center"
          placeholder="Masa / Müşteri">
      </div>
      <div id="mobile-ticket-items" class="flex-grow-1 overflow-y-auto p-3">
        <!-- Clone of cart items -->
      </div>
      <div class="p-3 surface-ground mt-auto">
        <div class="d-flex justify-content-between fs-4 fw-bold mb-3"><span>Toplam</span><span id="mobileTotalPrice">0
            $</span></div>
        <button id="mobileSaveButton" class="btn btn-gold w-100 fw-bold py-3">MUTFAĞA İLET <i
            class="bi bi-send-fill ms-2"></i></button>
      </div>
    </div>
  </div>

  <!-- OFFCANVAS: More Menu -->
  <div class="offcanvas offcanvas-end surface-elevated text-main" tabindex="-1" id="moreMenuOffcanvas">
    <div class="offcanvas-header border-theme">
      <h5 class="offcanvas-title">Menü</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
      <div class="list-group list-group-flush">
        <button class="list-group-item list-group-item-action surface-panel text-main border-theme p-3"
          data-bs-toggle="modal" data-bs-target="#historyModal">
          <i class="bi bi-journal-check me-2"></i> Geçmiş İşlemler
        </button>
        <button class="list-group-item list-group-item-action surface-panel text-main border-theme p-3"
          data-bs-toggle="modal" data-bs-target="#leaderboardModal">
          <i class="bi bi-trophy me-2"></i> Leaderboard
        </button>
        <!-- Dynamic Roles -->
        <button id="mobile-btn-kds"
          class="list-group-item list-group-item-action surface-panel text-main border-theme p-3 d-none"
          onclick="switchView('kds'); bootstrap.Offcanvas.getInstance('#moreMenuOffcanvas').hide()">
          <i class="bi bi-display me-2"></i> Mutfak Ekranı
        </button>
        <button id="mobile-btn-cashier"
          class="list-group-item list-group-item-action surface-panel text-main border-theme p-3 d-none"
          onclick="switchView('cashier'); bootstrap.Offcanvas.getInstance('#moreMenuOffcanvas').hide()">
          <i class="bi bi-cash-stack me-2"></i> Kasa Ekranı
        </button>

        <div class="p-3 mt-4">
          <div class="surface-ground rounded p-3 border-theme">
            <div class="text-center mb-3">
              <p class="text-sub small mb-1">Giriş Yapan</p>
              <h6 class="fw-bold text-gold mb-0" id="mobileActiveWaiter">-</h6>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <div class="surface-panel p-2 rounded text-center">
                  <span class="d-block x-small text-sub">SİPARİŞ</span>
                  <strong id="mobileWaiterOrderCount" class="text-main">0</strong>
                </div>
              </div>
              <div class="col-6">
                <div class="surface-panel p-2 rounded text-center">
                  <span class="d-block x-small text-sub">SERVİS</span>
                  <strong id="mobileWaiterServiceShare" class="text-success">0 $</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS (Reused logic, restyled) -->

  <!-- Active Orders -->
  <div class="modal fade" id="activeOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content surface-elevated border-theme shadow-lg">
        <div class="modal-header border-theme">
          <h5 class="modal-title fw-bold text-main">Açık Masalar</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <ul id="activeOrdersList" class="list-group list-group-flush"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content surface-elevated border-theme shadow-lg">
        <div class="modal-header border-theme">
          <h5 class="modal-title fw-bold text-main">Geçmiş</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <ul id="calcList" class="list-group list-group-flush"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="modal fade" id="leaderboardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content surface-elevated border-theme shadow-lg">
        <div class="modal-header border-theme">
          <h5 class="modal-title fw-bold text-main">Leaderboard</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <ul id="leaderboardList" class="list-group list-group-flush"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="waiterModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content surface-elevated border-theme shadow-lg">
        <div class="modal-body p-4 text-center">
          <div class="mb-4"><i class="bi bi-person-circle display-1" style="color: var(--accent);"></i></div>
          <h5 class="fw-bold mb-3 text-main">Garson Girişi</h5>
          <input type="text" class="form-control form-control-lg text-center mb-3" id="waiterModalInput"
            placeholder="Garson Adınız">
          <button type="button" class="btn btn-gold w-100 py-2 fw-bold" id="waiterModalSave">GİRİŞ YAP</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Receipt Canvas -->
  <canvas id="receiptCanvas" hidden></canvas>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script>
    // Firebase global variables
    window.FIREBASE_API_KEY = "__FIREBASE_API_KEY__";
    window.FIREBASE_AUTH_DOMAIN = "__FIREBASE_AUTH_DOMAIN__";
    window.FIREBASE_DATABASE_URL = "__FIREBASE_DATABASE_URL__";
    window.FIREBASE_PROJECT_ID = "__FIREBASE_PROJECT_ID__";
    window.FIREBASE_STORAGE_BUCKET = "__FIREBASE_STORAGE_BUCKET__";
    window.FIREBASE_MESSAGING_SENDER_ID = "__FIREBASE_MESSAGING_SENDER_ID__";
    window.FIREBASE_APP_ID = "__FIREBASE_APP_ID__";

    // Cloudinary configuration
    window.CLOUDINARY_CLOUD_NAME = "__CLOUDINARY_CLOUD_NAME__";
    window.CLOUDINARY_UPLOAD_PRESET = "__CLOUDINARY_UPLOAD_PRESET__";
  </script>
  <script type="module" src="./js/ui.js"></script>
</body>

</html>